(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function c(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=c(r);fetch(r.href,o)}})();var t,E;let _="",z=!0,h,b=null,w,S="#000000";const G={top:60,bottom:window.innerHeight*.5+25,left:60,right:60},W={top:100,bottom:100,left:300,right:50};async function Z(){const e=document.getElementById("serveiSelector2").value;let c=null,a=null;if(t.getLayer("clicked-layer")){const o=t.getSource("clicked-layer");o&&o._data&&(c=o._data,t.getLayer("clicked-layer-labels")&&(a=o._data))}let r;e==="orto"?(r="https://geoserveis.icgc.cat/styles/icgc_orto_estandard.json",S="#FFFFFF"):e==="topo"?(r="https://geoserveis.icgc.cat/styles/icgc_mapa_base_topografic.json",S="#000000"):e==="fosc"&&(r="https://geoserveis.icgc.cat/styles/icgc_mapa_base_fosc.json",S="#FFFFFF"),t.setStyle(r),t.once("styledata",()=>{const o=T(t.getStyle().layers),l=localStorage.getItem("clickedLayerColor")||"#f9f91d";c&&(t.getSource("clicked-layer")||t.addSource("clicked-layer",{type:"geojson",data:c}),t.getLayer("clicked-layer")||t.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":l,"fill-outline-color":l,"fill-opacity":.5}},o),a&&(t.removeLayer("clicked-layer"),t.getLayer("clicked-layer-labels")||(t.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":8,"circle-color":l}}),t.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","Codi_ICC"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":S}})))),e==="topo"?t.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):e==="orto"?t.setSky({"sky-color":"#37709e","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):e==="fosc"&&t.setSky({"sky-color":"#232423","sky-horizon-blend":.3,"horizon-color":"#969996","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#383838"}),q().then(function(){H()})})}async function q(){t.getSource("terrainMapZen")||t.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",encoding:"terrarium",tileSize:256,maxzoom:14})}function H(){try{t.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(n){console.log("ERROR addTerrain"),console.log(n)}}function A(){t.getLayer("clicked-layer")&&t.removeLayer("clicked-layer"),t.getLayer("clicked-layer-labels")&&t.removeLayer("clicked-layer-labels"),t.getSource("clicked-layer")&&t.removeSource("clicked-layer")}function U(n){const e=T(t.getStyle().layers);t.getLayer("hovered-layer")&&t.removeLayer("hovered-layer"),t.getSource("hovered-layer")&&t.removeSource("hovered-layer");for(let c=0;c<h.length;c++)n===h[c].id&&(t.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:h[c].geometry,properties:{}}}),t.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},e))}function J(){t.getLayer("hovered-layer")&&t.removeLayer("hovered-layer"),t.getSource("hovered-layer")&&t.removeSource("hovered-layer")}async function F(n,e,c){if(j(),D(),Y(),w){for(let i=0;i<w.length;i++){const{id:u,checked:d}=w[i];d===!0?(c!==""&&(c+=","),c+=u):z=!1}c+=",geocoder,elevacions"}z&&(c="all");const a=document.getElementById("infoPanelContent"),o=await(await fetch(`https://api.icgc.cat/territori/${c}/geo/${e}/${n}`)).json();o.responses&&(h=o.responses.features,a.innerHTML="");let l=[],s=null,p=null;if(!o.numResponses||!o.responses)a.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",$();else if(o.numResponses<1)a.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let i=0;i<o.responses.features.length;i++)l.push(o.responses.features[i].id),o.responses.features[i].id==="Geocodificador"?s=o.responses.features[i].properties:o.responses.features[i].id==="Elevació"&&(p=o.responses.features[i].properties.value);s&&(a.innerHTML+=`<p style='font-size: 1.2em; margin-bottom: 12px'><b>${s.etiqueta}</b> <span style='font-size: 0.65em; color: #8D9596'>(distància: ${s.distancia} km)</span></p>`),p&&(a.innerHTML+=`<b>Coordenades: </b> ${n.toFixed(5)}, ${e.toFixed(5)} <br>`,a.innerHTML+=`<b>Elevació: </b> ${p} metres<br><br>`);for(let i=0;i<l.length;i++)if(l[i]!=="Geocodificador"&&l[i]!=="Elevació"&&l[i]!=="H3 geospatial indexing system"){const u=l[i],d=document.createElement("button");d.textContent=u,d.classList.add("myButtonClass"),d.addEventListener("click",()=>{b=u,P(u,d)}),d.addEventListener("mouseover",()=>{U(u)}),d.addEventListener("mouseout",()=>{J()}),a.appendChild(d),a.appendChild(document.createElement("br"))}l.length>0&&!b?setTimeout(()=>{b=l[0],P(b,a.querySelector(".myButtonClass"))},25):b&&document.querySelectorAll(".myButtonClass").forEach(u=>{u.textContent.includes(b)&&P(b,u)})}$()}function P(n,e){const c=T(t.getStyle().layers);A();const a=document.querySelector(".closeButtonClass");a&&a.parentNode.removeChild(a);let r=new maplibregl.LngLatBounds;for(let s=0;s<h.length;s++)if(n===h[s].id){const p=localStorage.getItem("clickedLayerColor")||"#f9f91d",i=document.createElement("div");if(i.classList.add("layer-properties"),n==="Refugis climàtics"){const v=h[s].features,y={type:"FeatureCollection",features:v};t.addSource("clicked-layer",{type:"geojson",data:y}),t.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":7,"circle-color":p,"circle-stroke-color":"rgba(17, 16, 16, 1)","circle-stroke-width":2}}),t.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","nom"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":S}});const m=["nom","municipi","distance_km"];v.forEach((L,O)=>{const g=L.geometry.coordinates;g&&g.length===2&&typeof g[0]=="number"&&typeof g[1]=="number"&&r.extend(g);const C=L.properties;C&&(m.forEach(k=>{if(C[k]!==void 0){const x=document.createElement("div");x.textContent=`${k}: ${C[k]}`,i.appendChild(x)}}),i.appendChild(document.createElement("br")))})}else if(n==="Vèrtex xarxa utilitària"){const v=h[s].features,y={type:"FeatureCollection",features:v};t.addSource("clicked-layer",{type:"geojson",data:y}),t.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":7,"circle-color":p,"circle-stroke-color":"rgba(17, 16, 16, 1)","circle-stroke-width":2}}),t.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","Codi_ICC"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":S}});const m=["Codi_ICC","Municipi","distance_km","Enllaç"];v.forEach((L,O)=>{const g=L.geometry.coordinates;g&&g.length===2&&typeof g[0]=="number"&&typeof g[1]=="number"&&r.extend(g);const C=L.properties;C&&(m.forEach(k=>{if(C[k]!==void 0){const x=document.createElement("div");if(k==="Enllaç"){const B=document.createElement("a"),R=C[k];B.href=R,B.textContent="Fitxa ↓",B.target="_blank",B.classList.add("button-link"),x.appendChild(B)}else x.textContent=`${k}: ${C[k]}`;i.appendChild(x)}}),i.appendChild(document.createElement("br")))})}else{const f=h[s].geometry;if(f){t.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:f,properties:{}}}),t.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":p,"fill-outline-color":p,"fill-opacity":.5}},c),f.type==="Polygon"?f.coordinates[0].forEach(y=>{y&&y.length===2&&typeof y[0]=="number"&&typeof y[1]=="number"&&r.extend(y)}):f.type==="MultiPolygon"&&f.coordinates.forEach(y=>{y[0].forEach(m=>{m&&m.length===2&&typeof m[0]=="number"&&typeof m[1]=="number"&&r.extend(m)})});const v=h[s].properties;if(v)for(const[y,m]of Object.entries(v)){const L=document.createElement("div");L.textContent=`${y}: ${m}`,i.appendChild(L)}}}document.querySelectorAll(".layer-properties").forEach(f=>f.remove());const d=document.createElement("button");d.textContent="×",d.classList.add("closeButtonClass"),d.addEventListener("click",()=>{A(),i.remove(),d.remove(),e.classList.remove("highlighted-button")}),i.appendChild(d),e&&(e.parentNode.insertBefore(i,e.nextSibling),e.parentNode.insertBefore(d,e.nextSibling)),document.querySelectorAll(".myButtonClass").forEach(f=>f.classList.remove("highlighted-button")),e.classList.add("highlighted-button")}const l=window.innerWidth<750?G:W;r.isEmpty()||t.fitBounds(r,{padding:l})}function K(){ee(),t=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/styles/icgc_mapa_base_topografic.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1,maxPitch:85}),t.on("load",function(){q().then(function(){H()}),t.addControl(new maplibregl.NavigationControl,"top-right"),t.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"});let n=null;const e=20,c=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});t.addControl(c,"top-right");function a(r,o,l,s){const i=(l-r)*Math.PI/180,u=(s-o)*Math.PI/180,d=Math.sin(i/2)*Math.sin(i/2)+Math.cos(r*Math.PI/180)*Math.cos(l*Math.PI/180)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}c.on("geolocate",function(r){const o=r.coords.longitude,l=r.coords.latitude;if(n&&a(n.lat,n.lon,l,o)<e)return;n={lon:o,lat:l};const s={lngLat:{lng:o,lat:l}};t.fire("click",s)}),t.addControl(new oe,"top-right"),t.on("click",function(r){var o=document.getElementById("notification");o&&o.classList.remove("show");let l=r.lngLat.lng,s=r.lngLat.lat;b&&s&&l?(A(),F(s,l,_).then(()=>{document.querySelector(".myButtonClass.highlighted-button")&&P(b,document.querySelector(".myButtonClass.highlighted-button"))})):F(s,l,_);const p=localStorage.getItem("markerColor")||"#ff6e42";E?E.setLngLat([l,s]):E=new maplibregl.Marker({color:p}).setLngLat([l,s]).addTo(t)}),te()})}function T(n){let e="background";for(var c=0;c<n.length;c++)if(n[c].type=="symbol")return e=n[c].id,e}async function V(n){try{const e=`https://eines.icgc.cat/geocodificador/autocompletar?text=${encodeURIComponent(n)}&layers=topo1,address,topo2,pk`,a=await(await fetch(e)).json(),r=document.getElementById("autocomp-results");if(!r){console.error("No s'ha trobat el contenidor d'autocompletar.");return}if(r.innerHTML="",a.features&&a.features.length>0)a.features.forEach(o=>{const l=document.createElement("div");l.className="autocomplete-item",l.innerHTML=`<strong>${o.properties.etiqueta}</strong>, ${o.properties.municipi} (${o.properties.comarca})`,l.addEventListener("mouseover",()=>l.style.backgroundColor="#f0f0f0"),l.addEventListener("mouseout",()=>l.style.backgroundColor="white"),l.addEventListener("click",()=>{Q(o),r.innerHTML="",r.style.display="none"}),r.appendChild(l)});else{const o=document.createElement("div");o.className="autocomplete-item",o.textContent="No s'han trobat resultats.",r.appendChild(o)}}catch(e){console.error("Error en la cerca:",e),alert("Hi ha hagut un problema amb la cerca.")}}function Q(n){const e=n.geometry.coordinates;F(e[1],e[0],_),X(e)}let M=null;function X(n){M&&(M.remove(),M=null);const e=document.createElement("div");return e.className="marker",M=new maplibregl.Marker(e).setLngLat(n).addTo(t).togglePopup(),M}function Y(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function $(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}function ee(){document.getElementById("mapLoader").style.display="flex"}function te(){document.getElementById("mapLoader").style.display="none"}class oe{onAdd(e){return this._map=e,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function ne(){var n=document.getElementById("notification");n&&n.classList.remove("show");var e=document.getElementById("myModal"),c=document.getElementById("configListContainer");e.style.display="block",fetch("https://api.icgc.cat/territori/info").then(o=>o.json()).then(o=>{c.innerHTML="";const l=document.createElement("div"),s=document.createElement("input");s.type="checkbox",s.id="selectAllCheckbox";const p=document.createElement("label");l.id="selectDiv",p.id="selectLabel",p.htmlFor="selectAllCheckbox",p.textContent=" Seleccionar tots",l.appendChild(s),l.appendChild(p),c.appendChild(l),s.addEventListener("change",function(){c.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)').forEach(u=>{u.checked=s.checked})}),o.forEach(i=>{if(i.nomAPI!=="geocoder"&&i.nomAPI!=="elevacions"&&i.nomAPI!=="h3"){const u=document.createElement("div");u.className="config-item";const d=document.createElement("input");d.type="checkbox",d.id=`${i.nomAPI}`,d.name=i.name,d.checked=!0;const I=document.createElement("label");I.htmlFor=`checkbox-${i.nomAPI}`,I.textContent=i.text,u.appendChild(d),u.appendChild(I),c.appendChild(u),d.addEventListener("change",function(){r()})}}),j(),r()}).catch(o=>console.error("Error fetching data:",o));var a=document.getElementsByClassName("close")[0];a.onclick=function(){N(),e.style.display="none"},window.onclick=function(o){o.target==e&&(N(),e.style.display="none")};function r(){const o=c.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)'),l=Array.from(o).every(s=>s.checked);selectAllCheckbox.checked=l}}function N(){const n=document.querySelectorAll('.config-item input[type="checkbox"]'),e=Array.from(n).map(c=>({id:c.id,checked:c.checked}));localStorage.setItem("layerConfig",JSON.stringify(e))}function j(){const n=JSON.parse(localStorage.getItem("layerConfig"));n&&(w=n,n.forEach(e=>{const c=document.getElementById(e.id);c&&(c.checked=e.checked)}))}function D(){var n=document.getElementById("infoPanel");n.classList.add("open"),n.style.width="300px",document.getElementById("openPanel").style.display="none"}function re(){var n=document.getElementById("infoPanel");n.classList.remove("open"),n.style.width="0px",document.getElementById("openPanel").style.display="block"}function le(){K();const n=document.getElementById("textSelector"),e=document.getElementById("autocomp-results");n.addEventListener("input",a=>{const r=a.target.value.trim();r.length>=3?(V(r),e.style.display="block"):e.style.display="none"}),document.addEventListener("click",a=>{const r=document.getElementById("autocomp-results");!document.getElementById("textSelector").contains(a.target)&&!r.contains(a.target)&&(r.style.display="none")}),document.getElementById("layerConfig").addEventListener("click",()=>{ne()})}window.addEventListener("DOMContentLoaded",le);document.getElementById("layerColor").addEventListener("input",n=>{const e=n.target.value;localStorage.setItem("clickedLayerColor",e),ce(e)});function ce(n){t.getLayer("clicked-layer")&&(t.setPaintProperty("clicked-layer","fill-color",n),t.setPaintProperty("clicked-layer","fill-outline-color",n))}document.getElementById("markerColor").addEventListener("input",n=>{const e=n.target.value;localStorage.setItem("markerColor",e),ie(e)});function ie(n){if(E){E.setPopup(null);const e=E.getLngLat();E.remove(),E=new maplibregl.Marker({color:n}).setLngLat(e).addTo(t)}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(n=>{console.log("Service Worker registered with scope:",n.scope)},n=>{console.log("Service Worker registration failed:",n)})});window.closePanel=re;window.openPanel=D;window.onBaseChange=Z;
