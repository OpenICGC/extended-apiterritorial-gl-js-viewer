(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const i of l.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(r){if(r.ep)return;r.ep=!0;const l=n(r);fetch(r.href,l)}})();var e,v;let A="",T=!0,h,g=null,M;const R={top:60,bottom:window.innerHeight*.5+25,left:60,right:60},W={top:100,bottom:100,left:300,right:50};async function G(){const o=document.getElementById("serveiSelector2").value;let n=null;if(e.getLayer("clicked-layer")){const r=e.getSource("clicked-layer");r&&r._data&&(n=r._data)}let s;o==="orto"?s="https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json":o==="topo"?s="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json":o==="fosc"&&(s="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json"),e.setStyle(s),e.once("styledata",()=>{const r=_(e.getStyle().layers),l=localStorage.getItem("clickedLayerColor")||"#f9f91d";n&&(e.getSource("clicked-layer")||e.addSource("clicked-layer",{type:"geojson",data:n}),e.getLayer("clicked-layer")||e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":l,"fill-outline-color":l,"fill-opacity":.5}},r)),o==="topo"?e.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):o==="orto"?e.setSky({"sky-color":"#37709e","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):o==="fosc"&&e.setSky({"sky-color":"#232423","sky-horizon-blend":.3,"horizon-color":"#969996","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#383838"}),q().then(function(){F()})})}async function q(){e.getSource("terrainMapZen")||e.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",tileSize:512,maxzoom:14})}function F(){try{e.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(t){console.log("ERROR addTerrain"),console.log(t)}}function P(){e.getLayer("clicked-layer")&&e.removeLayer("clicked-layer"),e.getSource("clicked-layer")&&e.removeSource("clicked-layer")}function Z(t){const o=_(e.getStyle().layers);e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer");for(let n=0;n<h.length;n++)t===h[n].id&&(e.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:h[n].geometry,properties:{}}}),e.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},o))}function J(){e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer")}async function z(t,o,n){if(H(),N(),V(),M){for(let c=0;c<M.length;c++){const{id:u,checked:d}=M[c];d===!0?(n!==""&&(n+=","),n+=u):T=!1}n+=",geocoder,elevacions"}T&&(n="all");const s=document.getElementById("infoPanelContent"),l=await(await fetch(`https://api.icgc.cat/territori/${n}/geo/${o}/${t}`)).json();l.responses&&(h=l.responses.features,s.innerHTML="");let i=[],a=null,p=null;if(!l.numResponses||!l.responses)s.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",$();else if(l.numResponses<1)s.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let c=0;c<l.responses.features.length;c++)i.push(l.responses.features[c].id),l.responses.features[c].id==="Geocodificador"?a=l.responses.features[c].properties:l.responses.features[c].id==="Elevació"&&(p=l.responses.features[c].properties.value);a&&(s.innerHTML+=`<p style='font-size: 1.2em; margin-bottom: 12px'><b>${a.etiqueta}</b> <span style='font-size: 0.65em; color: #8D9596'>(distància: ${a.distancia} km)</span></p>`),p&&(s.innerHTML+=`<b>Coordenades: </b> ${t.toFixed(5)}, ${o.toFixed(5)} <br>`,s.innerHTML+=`<b>Elevació: </b> ${p} metres<br><br>`);for(let c=0;c<i.length;c++)if(i[c]!=="Geocodificador"&&i[c]!=="Elevació"&&i[c]!=="Malla hexagonal H3"){const u=i[c],d=document.createElement("button");d.textContent=u,d.classList.add("myButtonClass"),d.addEventListener("click",()=>{g=u,I(u,d)}),d.addEventListener("mouseover",()=>{Z(u)}),d.addEventListener("mouseout",()=>{J()}),s.appendChild(d),s.appendChild(document.createElement("br"))}i.length>0&&!g?setTimeout(()=>{g=i[0],I(g,s.querySelector(".myButtonClass"))},25):g&&document.querySelectorAll(".myButtonClass").forEach(u=>{u.textContent.includes(g)&&I(g,u)})}$()}function I(t,o){const n=_(e.getStyle().layers);P();const s=document.querySelector(".closeButtonClass");s&&s.parentNode.removeChild(s);let r=new maplibregl.LngLatBounds;for(let a=0;a<h.length;a++)if(t===h[a].id){const p=localStorage.getItem("clickedLayerColor")||"#f9f91d",c=document.createElement("div");if(c.classList.add("layer-properties"),t==="Vèrtex xarxa utilitària"){const C=h[a].features,y={type:"FeatureCollection",features:C};e.addSource("clicked-layer",{type:"geojson",data:y}),e.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":8,"circle-color":p}});const m=["Codi_ICC","Municipi","distance_km","Enllaç"];C.forEach((k,O)=>{const L=k.geometry.coordinates;L&&L.length===2&&typeof L[0]=="number"&&typeof L[1]=="number"&&r.extend(L);const x=k.properties;if(x){const w=document.createElement("div");w.textContent=`Feature ${O+1}`,w.style.fontWeight="bold",c.appendChild(w),m.forEach(E=>{if(x[E]!==void 0){const B=document.createElement("div");if(E==="Enllaç"){const S=document.createElement("a"),D=x[E].replace(/^ftp/,"https");S.href=D,S.textContent="Fitxa ↓",S.target="_blank",S.classList.add("button-link"),B.appendChild(S)}else B.textContent=`${E}: ${x[E]}`;c.appendChild(B)}}),c.appendChild(document.createElement("br"))}})}else{const f=h[a].geometry;if(f){e.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:f,properties:{}}}),e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":p,"fill-outline-color":p,"fill-opacity":.5}},n),f.type==="Polygon"?f.coordinates[0].forEach(y=>{y&&y.length===2&&typeof y[0]=="number"&&typeof y[1]=="number"&&r.extend(y)}):f.type==="MultiPolygon"&&f.coordinates.forEach(y=>{y[0].forEach(m=>{m&&m.length===2&&typeof m[0]=="number"&&typeof m[1]=="number"&&r.extend(m)})});const C=h[a].properties;if(C)for(const[y,m]of Object.entries(C)){const k=document.createElement("div");k.textContent=`${y}: ${m}`,c.appendChild(k)}}}document.querySelectorAll(".layer-properties").forEach(f=>f.remove());const d=document.createElement("button");d.textContent="×",d.classList.add("closeButtonClass"),d.addEventListener("click",()=>{P(),c.remove(),d.remove(),o.classList.remove("highlighted-button")}),c.appendChild(d),o&&(o.parentNode.insertBefore(c,o.nextSibling),o.parentNode.insertBefore(d,o.nextSibling)),document.querySelectorAll(".myButtonClass").forEach(f=>f.classList.remove("highlighted-button")),o.classList.add("highlighted-button")}const i=window.innerWidth<750?R:W;r.isEmpty()||e.fitBounds(r,{padding:i})}function U(){Q(),e=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1,maxPitch:85}),e.on("load",function(){q().then(function(){F()}),e.addControl(new maplibregl.NavigationControl,"top-right"),e.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"});let t=null;const o=20,n=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});e.addControl(n,"top-right");function s(r,l,i,a){const c=(i-r)*Math.PI/180,u=(a-l)*Math.PI/180,d=Math.sin(c/2)*Math.sin(c/2)+Math.cos(r*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}n.on("geolocate",function(r){const l=r.coords.longitude,i=r.coords.latitude;if(t&&s(t.lat,t.lon,i,l)<o)return;t={lon:l,lat:i};const a={lngLat:{lng:l,lat:i}};e.fire("click",a)}),e.addControl(new Y,"top-right"),e.on("click",function(r){var l=document.getElementById("notification");l&&l.classList.remove("show");let i=r.lngLat.lng,a=r.lngLat.lat;g&&a&&i?(P(),z(a,i,A).then(()=>{document.querySelector(".myButtonClass.highlighted-button")&&I(g,document.querySelector(".myButtonClass.highlighted-button"))})):z(a,i,A);const p=localStorage.getItem("markerColor")||"#ff6e42";v?v.setLngLat([i,a]):v=new maplibregl.Marker({color:p}).setLngLat([i,a]).addTo(e)}),X()})}function _(t){let o="background";for(var n=0;n<t.length;n++)if(t[n].type=="symbol")return o=t[n].id,o}async function K(t){const n=await(await fetch(`https://api.icgc.cat/territori/adress/${t}`)).json();n.features?(e.getLayer("punts2")?(e.removeLayer("punts2").removeSource("punts2"),e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:n.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})):(e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:n.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})),e.flyTo({center:[n.features[0].geometry.coordinates[0],n.features[0].geometry.coordinates[1]],zoom:11,essential:!0})):alert(n);const s=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});e.getLayer("punts2")&&(e.on("mouseenter","punts2",function(r){e.getCanvas().style.cursor="pointer",s.setLngLat(r.features[0].geometry.coordinates).setHTML(`Adreça: <b>${r.features[0].properties.etiqueta}</b><br>
      Carrer: <b>${r.features[0].properties.nom}</b><br>
      Municipi: <b>${r.features[0].properties.municipi}</b><br>
      Codi Postal: <b>${r.features[0].properties.codi_postal}</b><br>`).addTo(e)}),e.on("mouseleave","punts2",function(r){e.getCanvas().style.cursor="",s.remove()}))}function V(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function $(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}function Q(){document.getElementById("mapLoader").style.display="flex"}function X(){document.getElementById("mapLoader").style.display="none"}class Y{onAdd(o){return this._map=o,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function ee(){var t=document.getElementById("notification");t&&t.classList.remove("show");var o=document.getElementById("myModal"),n=document.getElementById("configListContainer");o.style.display="block",fetch("https://api.icgc.cat/territori/info").then(l=>l.json()).then(l=>{n.innerHTML="";const i=document.createElement("div"),a=document.createElement("input");a.type="checkbox",a.id="selectAllCheckbox";const p=document.createElement("label");i.id="selectDiv",p.id="selectLabel",p.htmlFor="selectAllCheckbox",p.textContent=" Seleccionar tots",i.appendChild(a),i.appendChild(p),n.appendChild(i),a.addEventListener("change",function(){n.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)').forEach(u=>{u.checked=a.checked})}),l.forEach(c=>{if(c.nomAPI!=="geocoder"&&c.nomAPI!=="elevacions"){const u=document.createElement("div");u.className="config-item";const d=document.createElement("input");d.type="checkbox",d.id=`${c.nomAPI}`,d.name=c.name,d.checked=!0;const b=document.createElement("label");b.htmlFor=`checkbox-${c.nomAPI}`,b.textContent=c.text,u.appendChild(d),u.appendChild(b),n.appendChild(u),d.addEventListener("change",function(){r()})}}),H(),r()}).catch(l=>console.error("Error fetching data:",l));var s=document.getElementsByClassName("close")[0];s.onclick=function(){j(),o.style.display="none"},window.onclick=function(l){l.target==o&&(j(),o.style.display="none")};function r(){const l=n.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)'),i=Array.from(l).every(a=>a.checked);selectAllCheckbox.checked=i}}function j(){const t=document.querySelectorAll('.config-item input[type="checkbox"]'),o=Array.from(t).map(n=>({id:n.id,checked:n.checked}));localStorage.setItem("layerConfig",JSON.stringify(o))}function H(){const t=JSON.parse(localStorage.getItem("layerConfig"));t&&(M=t,t.forEach(o=>{const n=document.getElementById(o.id);n&&(n.checked=o.checked)}))}function N(){var t=document.getElementById("infoPanel");t.classList.add("open"),t.style.width="300px",document.getElementById("openPanel").style.display="none"}function te(){var t=document.getElementById("infoPanel");t.classList.remove("open"),t.style.width="0px",document.getElementById("openPanel").style.display="block"}function oe(){U();const t=document.getElementById("textSelector");t.addEventListener("change",()=>{const n=t.value;K(n)}),document.getElementById("layerConfig").addEventListener("click",()=>{ee()})}window.addEventListener("DOMContentLoaded",oe);document.getElementById("layerColor").addEventListener("input",t=>{const o=t.target.value;localStorage.setItem("clickedLayerColor",o),ne(o)});function ne(t){e.getLayer("clicked-layer")&&(e.setPaintProperty("clicked-layer","fill-color",t),e.setPaintProperty("clicked-layer","fill-outline-color",t))}document.getElementById("markerColor").addEventListener("input",t=>{const o=t.target.value;localStorage.setItem("markerColor",o),re(o)});function re(t){if(v){v.setPopup(null);const o=v.getLngLat();v.remove(),v=new maplibregl.Marker({color:t}).setLngLat(o).addTo(e)}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(t=>{console.log("Service Worker registered with scope:",t.scope)},t=>{console.log("Service Worker registration failed:",t)})});window.closePanel=te;window.openPanel=N;window.onBaseChange=G;
