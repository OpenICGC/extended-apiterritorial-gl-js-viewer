(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function c(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(l){if(l.ep)return;l.ep=!0;const o=c(l);fetch(l.href,o)}})();var n,h;let P="",q=!0,v,L=null,M,k="#000000";const Z={top:60,bottom:window.innerHeight*.5+25,left:60,right:60},J={top:100,bottom:100,left:300,right:50};async function K(){const t=document.getElementById("serveiSelector2").value;let c=null,a=null;if(n.getLayer("clicked-layer")){const o=n.getSource("clicked-layer");o&&o._data&&(c=o._data,n.getLayer("clicked-layer-labels")&&(a=o._data))}let l;t==="orto"?(l="https://geoserveis.icgc.cat/styles/icgc_orto_estandard.json",k="#FFFFFF"):t==="topo"?(l="https://geoserveis.icgc.cat/styles/icgc_mapa_base_topografic.json",k="#000000"):t==="fosc"&&(l="https://geoserveis.icgc.cat/styles/icgc_mapa_base_fosc.json",k="#FFFFFF"),n.setStyle(l),n.once("styledata",()=>{const o=z(n.getStyle().layers),r=localStorage.getItem("clickedLayerColor")||"#f9f91d";c&&(n.getSource("clicked-layer")||n.addSource("clicked-layer",{type:"geojson",data:c}),n.getLayer("clicked-layer")||n.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":r,"fill-outline-color":r,"fill-opacity":.5}},o),a&&(n.removeLayer("clicked-layer"),n.getLayer("clicked-layer-labels")||(n.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":8,"circle-color":r}}),n.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","Codi_ICC"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":k}})))),t==="topo"?n.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):t==="orto"?n.setSky({"sky-color":"#37709e","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):t==="fosc"&&n.setSky({"sky-color":"#232423","sky-horizon-blend":.3,"horizon-color":"#969996","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#383838"}),D().then(function(){H()})})}function F(e){let t;e==="orto"?(t="https://geoserveis.icgc.cat/styles/icgc_orto_estandard.json",k="#FFFFFF"):e==="topo"?(t="https://geoserveis.icgc.cat/styles/icgc_mapa_base_topografic.json",k="#000000"):e==="fosc"&&(t="https://geoserveis.icgc.cat/styles/icgc_mapa_base_fosc.json",k="#FFFFFF"),n.setStyle(t),document.documentElement.style.setProperty("--text-color",k)}async function D(){n.getSource("terrainMapZen")||n.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",encoding:"terrarium",tileSize:256,maxzoom:14})}function H(){try{n.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(e){console.log("ERROR addTerrain"),console.log(e)}}function A(){n.getLayer("clicked-layer")&&n.removeLayer("clicked-layer"),n.getLayer("clicked-layer-labels")&&n.removeLayer("clicked-layer-labels"),n.getSource("clicked-layer")&&n.removeSource("clicked-layer")}function V(e){const t=z(n.getStyle().layers);n.getLayer("hovered-layer")&&n.removeLayer("hovered-layer"),n.getSource("hovered-layer")&&n.removeSource("hovered-layer");for(let c=0;c<v.length;c++)e===v[c].id&&(n.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:v[c].geometry,properties:{}}}),n.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},t))}function Q(){n.getLayer("hovered-layer")&&n.removeLayer("hovered-layer"),n.getSource("hovered-layer")&&n.removeSource("hovered-layer")}async function T(e,t,c){if(O(),G(),oe(),M){for(let i=0;i<M.length;i++){const{id:u,checked:d}=M[i];d===!0?(c!==""&&(c+=","),c+=u):q=!1}c+=",geocoder,elevacions"}q&&(c="all");const a=document.getElementById("infoPanelContent"),o=await(await fetch(`https://api.icgc.cat/territori/${c}/geo/${t}/${e}`)).json();o.responses&&(v=o.responses.features,a.innerHTML="");let r=[],s=null,p=null;if(!o.numResponses||!o.responses)a.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",N();else if(o.numResponses<1)a.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let i=0;i<o.responses.features.length;i++)r.push(o.responses.features[i].id),o.responses.features[i].id==="Geocodificador"?s=o.responses.features[i].properties:o.responses.features[i].id==="Elevació"&&(p=o.responses.features[i].properties.value);s&&(a.innerHTML+=`<p style='font-size: 1.2em; margin-bottom: 12px'><b>${s.etiqueta}</b> <span style='font-size: 0.65em; color: #8D9596'>(distància: ${s.distancia} km)</span></p>`),p&&(a.innerHTML+=`<b>Coordenades: </b> ${e.toFixed(5)}, ${t.toFixed(5)} <br>`,a.innerHTML+=`<b>Elevació: </b> ${p} metres<br><br>`);for(let i=0;i<r.length;i++)if(r[i]!=="Geocodificador"&&r[i]!=="Elevació"&&r[i]!=="H3 geospatial indexing system"){const u=r[i],d=document.createElement("button");d.textContent=u,d.classList.add("myButtonClass"),d.addEventListener("click",()=>{L=u,_(u,d)}),d.addEventListener("mouseover",()=>{V(u)}),d.addEventListener("mouseout",()=>{Q()}),a.appendChild(d),a.appendChild(document.createElement("br"))}r.length>0&&!L?setTimeout(()=>{L=r[0],_(L,a.querySelector(".myButtonClass"))},25):L&&document.querySelectorAll(".myButtonClass").forEach(u=>{u.textContent.includes(L)&&_(L,u)})}N()}function _(e,t){const c=z(n.getStyle().layers);A();const a=document.querySelector(".closeButtonClass");a&&a.parentNode.removeChild(a);let l=new maplibregl.LngLatBounds;for(let s=0;s<v.length;s++)if(e===v[s].id){const p=localStorage.getItem("clickedLayerColor")||"#f9f91d",i=document.createElement("div");if(i.classList.add("layer-properties"),e==="Refugis climàtics"){const C=v[s].features,f={type:"FeatureCollection",features:C};n.addSource("clicked-layer",{type:"geojson",data:f}),n.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":7,"circle-color":p,"circle-stroke-color":"rgba(17, 16, 16, 1)","circle-stroke-width":2}}),n.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","nom"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":k}});const y=["nom","municipi","distance_km"];C.forEach((E,U)=>{const g=E.geometry.coordinates;g&&g.length===2&&typeof g[0]=="number"&&typeof g[1]=="number"&&l.extend(g);const x=E.properties;x&&(y.forEach(b=>{if(x[b]!==void 0){const I=document.createElement("div");I.textContent=`${b}: ${x[b]}`,i.appendChild(I)}}),i.appendChild(document.createElement("br")))})}else if(e==="Vèrtex xarxa utilitària"){const C=v[s].features,f={type:"FeatureCollection",features:C};n.addSource("clicked-layer",{type:"geojson",data:f}),n.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":7,"circle-color":p,"circle-stroke-color":"rgba(17, 16, 16, 1)","circle-stroke-width":2}}),n.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","Codi_ICC"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":k}});const y=["Codi_ICC","Municipi","distance_km","Enllaç"];C.forEach((E,U)=>{const g=E.geometry.coordinates;g&&g.length===2&&typeof g[0]=="number"&&typeof g[1]=="number"&&l.extend(g);const x=E.properties;x&&(y.forEach(b=>{if(x[b]!==void 0){const I=document.createElement("div");if(b==="Enllaç"){const B=document.createElement("a"),W=x[b];B.href=W,B.textContent="Fitxa ↓",B.target="_blank",B.classList.add("button-link"),I.appendChild(B)}else I.textContent=`${b}: ${x[b]}`;i.appendChild(I)}}),i.appendChild(document.createElement("br")))})}else{const m=v[s].geometry;if(m){n.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:m,properties:{}}}),n.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":p,"fill-outline-color":p,"fill-opacity":.5}},c),m.type==="Polygon"?m.coordinates[0].forEach(f=>{f&&f.length===2&&typeof f[0]=="number"&&typeof f[1]=="number"&&l.extend(f)}):m.type==="MultiPolygon"&&m.coordinates.forEach(f=>{f[0].forEach(y=>{y&&y.length===2&&typeof y[0]=="number"&&typeof y[1]=="number"&&l.extend(y)})});const C=v[s].properties;if(C)for(const[f,y]of Object.entries(C)){const E=document.createElement("div");E.textContent=`${f}: ${y}`,i.appendChild(E)}}}document.querySelectorAll(".layer-properties").forEach(m=>m.remove());const d=document.createElement("button");d.textContent="×",d.classList.add("closeButtonClass"),d.addEventListener("click",()=>{A(),i.remove(),d.remove(),t.classList.remove("highlighted-button")}),i.appendChild(d),t&&(t.parentNode.insertBefore(i,t.nextSibling),t.parentNode.insertBefore(d,t.nextSibling)),document.querySelectorAll(".myButtonClass").forEach(m=>m.classList.remove("highlighted-button")),t.classList.add("highlighted-button")}const r=window.innerWidth<750?Z:J;l.isEmpty()||n.fitBounds(l,{padding:r})}function X(){ne(),n=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/styles/icgc_mapa_base_topografic.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1,maxPitch:85}),n.on("load",function(){D().then(function(){H()}),n.addControl(new maplibregl.NavigationControl,"top-right"),n.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"});let e=null;const t=20,c=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});n.addControl(c,"top-right");function a(l,o,r,s){const i=(r-l)*Math.PI/180,u=(s-o)*Math.PI/180,d=Math.sin(i/2)*Math.sin(i/2)+Math.cos(l*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}c.on("geolocate",function(l){const o=l.coords.longitude,r=l.coords.latitude;if(e&&a(e.lat,e.lon,r,o)<t)return;e={lon:o,lat:r};const s={lngLat:{lng:o,lat:r}};n.fire("click",s)}),n.addControl(new le,"top-right"),n.on("click",function(l){var o=document.getElementById("notification");o&&o.classList.remove("show");let r=l.lngLat.lng,s=l.lngLat.lat;L&&s&&r?(A(),T(s,r,P).then(()=>{document.querySelector(".myButtonClass.highlighted-button")&&_(L,document.querySelector(".myButtonClass.highlighted-button"))})):T(s,r,P),S&&(S.remove(),S=null);const p=localStorage.getItem("markerColor")||"#ff6e42";h?h.setLngLat([r,s]):h=new maplibregl.Marker({color:p}).setLngLat([r,s]).addTo(n)}),re()})}function z(e){let t="background";for(var c=0;c<e.length;c++)if(e[c].type=="symbol")return t=e[c].id,t}async function Y(e){try{const t=`https://eines.icgc.cat/geocodificador/autocompletar?text=${encodeURIComponent(e)}&layers=topo1,address,topo2,pk`,a=await(await fetch(t)).json();console.log("dades",a)}catch(t){console.error("Error en la cerca:",t)}}async function R(e){try{const t=`https://eines.icgc.cat/geocodificador/autocompletar?text=${encodeURIComponent(e)}&layers=topo1,address,topo2,pk`,a=await(await fetch(t)).json(),l=document.getElementById("autocomp-results");if(!l){console.error("No s'ha trobat el contenidor d'autocompletar.");return}if(l.innerHTML="",a.features&&a.features.length>0)a.features.forEach(o=>{const r=document.createElement("div");r.className="autocomplete-item",r.innerHTML=`<strong>${o.properties.etiqueta}</strong> (${o.properties.comarca})`,r.addEventListener("mouseover",()=>r.style.backgroundColor="#f0f0f0"),r.addEventListener("mouseout",()=>r.style.backgroundColor="white"),r.addEventListener("click",()=>{ee(o),l.innerHTML="",l.style.display="none"}),l.appendChild(r)});else{const o=document.createElement("div");o.className="autocomplete-item",o.textContent="No s'han trobat resultats.",l.appendChild(o)}}catch(t){console.error("Error en la cerca:",t)}}function ee(e){h&&(h.remove(),h=null);const t=e.geometry.coordinates;T(t[1],t[0],P),te(t)}let S=null;function te(e){S&&(S.remove(),S=null);const t=document.createElement("div");return t.className="marker",S=new maplibregl.Marker(t).setLngLat(e).addTo(n).togglePopup(),S}function oe(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function N(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}function ne(){document.getElementById("mapLoader").style.display="flex"}function re(){document.getElementById("mapLoader").style.display="none"}class le{onAdd(t){return this._map=t,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function ce(){var e=document.getElementById("notification");e&&e.classList.remove("show");var t=document.getElementById("myModal"),c=document.getElementById("configListContainer");t.style.display="block",fetch("https://api.icgc.cat/territori/info").then(o=>o.json()).then(o=>{c.innerHTML="";const r=document.createElement("div"),s=document.createElement("input");s.type="checkbox",s.id="selectAllCheckbox";const p=document.createElement("label");r.id="selectDiv",p.id="selectLabel",p.htmlFor="selectAllCheckbox",p.textContent=" Seleccionar tots",r.appendChild(s),r.appendChild(p),c.appendChild(r),s.addEventListener("change",function(){c.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)').forEach(u=>{u.checked=s.checked})}),o.forEach(i=>{if(i.nomAPI!=="geocoder"&&i.nomAPI!=="elevacions"&&i.nomAPI!=="h3"){const u=document.createElement("div");u.className="config-item";const d=document.createElement("input");d.type="checkbox",d.id=`${i.nomAPI}`,d.name=i.name,d.checked=!0;const w=document.createElement("label");w.htmlFor=`checkbox-${i.nomAPI}`,w.textContent=i.text,u.appendChild(d),u.appendChild(w),c.appendChild(u),d.addEventListener("change",function(){l()})}}),O(),l()}).catch(o=>console.error("Error fetching data:",o));var a=document.getElementsByClassName("close")[0];a.onclick=function(){$(),t.style.display="none"},window.onclick=function(o){o.target==t&&($(),t.style.display="none")};function l(){const o=c.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)'),r=Array.from(o).every(s=>s.checked);selectAllCheckbox.checked=r}}function $(){const e=document.querySelectorAll('.config-item input[type="checkbox"]'),t=Array.from(e).map(c=>({id:c.id,checked:c.checked}));localStorage.setItem("layerConfig",JSON.stringify(t))}function O(){const e=JSON.parse(localStorage.getItem("layerConfig"));e&&(M=e,e.forEach(t=>{const c=document.getElementById(t.id);c&&(c.checked=t.checked)}))}function ie(){const e=window.location.search||window.location.hash.split("?")[1]||"";return new URLSearchParams(e)}function G(){var e=document.getElementById("infoPanel");e.classList.add("open"),e.style.width="300px",document.getElementById("openPanel").style.display="none"}function ae(){var e=document.getElementById("infoPanel");e.classList.remove("open"),e.style.width="0px",document.getElementById("openPanel").style.display="block"}function se(){X();const t=ie().get("q");t&&(console.log("Paràmetre 'q' rebut:",t),Y(t));const c=document.getElementById("textSelector"),a=document.getElementById("autocomp-results");c.addEventListener("input",o=>{const r=o.target.value.trim();r.length>=3?(R(r),a.style.display="block"):a.style.display="none"}),document.addEventListener("click",o=>{const r=document.getElementById("autocomp-results");!document.getElementById("textSelector").contains(o.target)&&!r.contains(o.target)&&(r.style.display="none")}),document.getElementById("layerConfig").addEventListener("click",()=>{ce()})}function de(){if(localStorage.getItem("notificationShown")){const e=document.getElementById("notification");e&&(e.classList.remove("show"),e.style.display="none")}else{const e=document.getElementById("notification");e&&(e.style.display="block",e.classList.add("show"),setTimeout(()=>{e.classList.remove("show"),e.style.display="none"},7e3),localStorage.setItem("notificationShown","true"))}}window.addEventListener("DOMContentLoaded",se);window.addEventListener("DOMContentLoaded",()=>{de();const e=localStorage.getItem("selectedBase");e?(document.getElementById("serveiSelector2").value=e,F(e)):(document.getElementById("serveiSelector2").value="topo",F("topo"))});document.getElementById("layerColor").addEventListener("input",e=>{const t=e.target.value;localStorage.setItem("clickedLayerColor",t),ue(t)});function ue(e){n.getLayer("clicked-layer")&&(n.setPaintProperty("clicked-layer","fill-color",e),n.setPaintProperty("clicked-layer","fill-outline-color",e))}document.getElementById("markerColor").addEventListener("input",e=>{const t=e.target.value;localStorage.setItem("markerColor",t),pe(t)});document.getElementById("serveiSelector2").addEventListener("change",function(){const e=this.value;localStorage.setItem("selectedBase",e),F(e)});var j;(j=document.getElementById("mobileSearchForm"))==null||j.addEventListener("submit",function(e){e.preventDefault();const c=document.getElementById("mobileTextSelector").value.trim();c.length>=3?(R(c),document.getElementById("autocomp-results").style.display="block"):document.getElementById("autocomp-results").style.display="none"});function pe(e){if(h){h.setPopup(null);const t=h.getLngLat();h.remove(),h=new maplibregl.Marker({color:e}).setLngLat(t).addTo(n)}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(e=>{console.log("Service Worker registered with scope:",e.scope)},e=>{console.log("Service Worker registration failed:",e)})});window.closePanel=ae;window.openPanel=G;window.onBaseChange=K;
