(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const d of n.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function o(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(t){if(t.ep)return;t.ep=!0;const n=o(t);fetch(t.href,n)}})();var e,b;let k="",w=!0,m,y=null,L;const $={top:5,bottom:window.innerHeight*.5},j={top:100,bottom:100,left:300,right:50};async function A(){const r=S(e.getStyle().layers),o=document.getElementById("serveiSelector2").value;let a=null;if(e.getLayer("clicked-layer")){const n=e.getSource("clicked-layer");n&&n._data&&(a=n._data)}let t;o==="orto"?t="https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json":o==="topo"?t="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json":o==="fosc"&&(t="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json"),e.setStyle(t),e.once("styledata",()=>{a&&(e.getSource("clicked-layer")||e.addSource("clicked-layer",{type:"geojson",data:a}),e.getLayer("clicked-layer")||e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":"#f9f91d","fill-outline-color":"#f9f91d","fill-opacity":.5}},r)),_().then(function(){I()})})}async function _(){e.getSource("terrainMapZen")||e.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",tileSize:512,maxzoom:14})}function I(){try{e.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(r){console.log("ERROR addTerrain"),console.log(r)}}function C(){e.getLayer("clicked-layer")&&e.removeLayer("clicked-layer"),e.getSource("clicked-layer")&&e.removeSource("clicked-layer")}function N(r){const i=S(e.getStyle().layers);e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer");for(let o=0;o<m.length;o++)r===m[o].id&&(e.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:m[o].geometry,properties:{}}}),e.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},i))}function H(){e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer")}async function B(r,i,o){M(),T(),F();for(let s=0;s<L.length;s++){const{id:c,checked:p}=L[s];p===!0?(o!==""&&(o+=","),o+=c):w=!1}o+=",geocoder,elevacions",w&&(o="all");const a=document.getElementById("infoPanelContent"),n=await(await fetch(`https://api.icgc.cat/territori/${o}/geo/${i}/${r}`)).json();console.log("dades que passa?",n),n.responses&&(m=n.responses.features,a.innerHTML="");let d=[],l=null,u=null;if(!n.numResponses||!n.responses)a.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",x();else if(n.numResponses<2)a.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let s=0;s<n.responses.features.length;s++)d.push(n.responses.features[s].id),n.responses.features[s].id==="Geocodificador"?l=n.responses.features[s].properties:n.responses.features[s].id==="Elevació"&&(u=n.responses.features[s].properties.value);l&&(a.innerHTML+=`<b>Adreça: </b> ${l.etiqueta} <br>`),u&&(a.innerHTML+=`<b>Coordenades: </b> ${r.toFixed(4)}, ${i.toFixed(4)} <br>`,a.innerHTML+=`<b>Elevació: </b> ${u} metres<br><br>`);for(let s=0;s<d.length;s++)if(d[s]!=="Geocodificador"&&d[s]!=="Elevació"&&d[s]!=="H3 geospatial indexing system"){const c=d[s],p=document.createElement("button");p.textContent=c,p.classList.add("myButtonClass"),p.addEventListener("click",()=>{y=c,h(c,p)}),p.addEventListener("mouseover",()=>{N(c)}),p.addEventListener("mouseout",()=>{H()}),a.appendChild(p),a.appendChild(document.createElement("br"))}d.length>0&&!y?setTimeout(()=>{y=d[0],h(y,a.querySelector(".myButtonClass"))},25):y&&document.querySelectorAll(".myButtonClass").forEach(c=>{c.textContent.includes(y)&&h(y,c)})}x()}function h(r,i){const o=S(e.getStyle().layers);C();const a=document.querySelector(".closeButtonClass");a&&a.parentNode.removeChild(a);let t=new maplibregl.LngLatBounds;for(let l=0;l<m.length;l++)if(r===m[l].id){e.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:m[l].geometry,properties:{}}}),e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":"#f9f91d","fill-outline-color":"#f9f91d","fill-opacity":.5}},o);const u=m[l].geometry;u.type==="Polygon"?u.coordinates[0].forEach(f=>{t.extend(f)}):u.type==="MultiPolygon"&&u.coordinates.forEach(f=>{f[0].forEach(v=>{t.extend(v)})}),document.querySelectorAll(".layer-properties").forEach(f=>f.remove());const c=document.createElement("div");c.classList.add("layer-properties");const p=m[l].properties;for(const[f,v]of Object.entries(p)){const E=document.createElement("div");E.textContent=`${f}: ${v}`,c.appendChild(E)}const g=document.createElement("button");g.textContent="×",g.classList.add("closeButtonClass"),g.addEventListener("click",()=>{C(),c.remove(),g.remove(),i.classList.remove("highlighted-button")}),c.appendChild(g),i.parentNode.insertBefore(c,i.nextSibling),i.parentNode.insertBefore(g,i.nextSibling),document.querySelectorAll(".myButtonClass").forEach(f=>f.classList.remove("highlighted-button")),i.classList.add("highlighted-button")}const d=window.innerWidth<750?$:j;t&&e.fitBounds(t,{padding:d})}function O(){e=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1}),e.on("load",function(){_().then(function(){I()}),e.addControl(new maplibregl.NavigationControl,"top-right");var r=new maplibregl.FullscreenControl;e.addControl(r,"top-right");const i=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1});i.on("geolocate",function(o){const a=o.coords.longitude,t=o.coords.latitude,n={lngLat:{lng:a,lat:t}};e.fire("click",n)}),e.addControl(i,"top-right"),e.addControl(new D,"top-right"),e.on("click",function(o){var a=document.getElementById("notification");a&&a.classList.remove("show");let t=o.lngLat.lng,n=o.lngLat.lat;y&&n&&t?(C(),B(n,t,k).then(()=>{h(y,document.querySelector(".myButtonClass.highlighted-button"))})):B(n,t,k),b?b.setLngLat([t,n]):b=new maplibregl.Marker({color:"#FF6E42"}).setLngLat([t,n]).addTo(e)})})}function S(r){let i="background";for(var o=0;o<r.length;o++)if(r[o].type=="symbol"&&r[o]["source-layer"]!=="contour")return i=r[o].id,i}async function q(r){const o=await(await fetch(`https://api.icgc.cat/territori/adress/${r}`)).json();o.features?(e.getLayer("punts2")?(e.removeLayer("punts2").removeSource("punts2"),e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:o.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})):(e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:o.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})),e.flyTo({center:[o.features[0].geometry.coordinates[0],o.features[0].geometry.coordinates[1]],zoom:11,essential:!0})):alert(o);const a=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});e.getLayer("punts2")&&(e.on("mouseenter","punts2",function(t){e.getCanvas().style.cursor="pointer",a.setLngLat(t.features[0].geometry.coordinates).setHTML(`Adreça: <b>${t.features[0].properties.etiqueta}</b><br>
      Carrer: <b>${t.features[0].properties.nom}</b><br>
      Municipi: <b>${t.features[0].properties.municipi}</b><br>
      Codi Postal: <b>${t.features[0].properties.codi_postal}</b><br>`).addTo(e)}),e.on("mouseleave","punts2",function(t){e.getCanvas().style.cursor="",a.remove()}))}function F(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function x(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}class D{onAdd(i){return this._map=i,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function P(){const r=document.querySelectorAll('.config-item input[type="checkbox"]'),i=Array.from(r).map(o=>({id:o.id,checked:o.checked}));localStorage.setItem("layerConfig",JSON.stringify(i))}function M(){const r=JSON.parse(localStorage.getItem("layerConfig"));r&&(L=r,r.forEach(i=>{const o=document.getElementById(i.id);o&&(o.checked=i.checked)}))}function T(){var r=document.getElementById("infoPanel");r.classList.add("open"),r.style.width="300px",document.getElementById("openPanel").style.display="none"}function G(){var r=document.getElementById("infoPanel");r.classList.remove("open"),r.style.width="0px",document.getElementById("openPanel").style.display="block"}function R(){O();function r(){var a=document.getElementById("notification");a&&a.classList.remove("show");var t=document.getElementById("myModal"),n=document.getElementById("configListContainer");t.style.display="block",fetch("https://api.icgc.cat/territori/info").then(l=>l.json()).then(l=>{n.innerHTML="",l.forEach(u=>{if(u.nomAPI!=="geocoder"&&u.nomAPI!=="elevacions"){const s=document.createElement("div");s.className="config-item";const c=document.createElement("input");c.type="checkbox",c.id=`${u.nomAPI}`,c.name=u.name,c.checked=!0;const p=document.createElement("label");p.htmlFor=`checkbox-${u.nomAPI}`,p.textContent=u.text,s.appendChild(c),s.appendChild(p),n.appendChild(s)}}),M()}).catch(l=>console.error("Error fetching data:",l));var d=document.getElementsByClassName("close")[0];d.onclick=function(){P(),t.style.display="none"},window.onclick=function(l){l.target==t&&(P(),t.style.display="none")}}const i=document.getElementById("textSelector");i.addEventListener("change",()=>{const a=i.value;q(a)}),document.getElementById("layerConfig").addEventListener("click",()=>{r()})}window.addEventListener("DOMContentLoaded",R);"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(r=>{console.log("Service Worker registered with scope:",r.scope)},r=>{console.log("Service Worker registration failed:",r)})});window.closePanel=G;window.openPanel=T;window.onBaseChange=A;
