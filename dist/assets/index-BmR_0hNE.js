(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function r(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(t){if(t.ep)return;t.ep=!0;const n=r(t);fetch(t.href,n)}})();var e,L;let E="all",u,f=null;const k={top:5,bottom:window.innerHeight*.5},M=150;async function I(){const o=S(e.getStyle().layers),r=document.getElementById("serveiSelector2").value;let i=null;if(e.getLayer("clicked-layer")){const n=e.getSource("clicked-layer");n&&n._data&&(i=n._data)}let t;r==="orto"?t="https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json":r==="topo"?t="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json":r==="fosc"&&(t="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json"),e.setStyle(t),e.once("styledata",()=>{i&&(e.getSource("clicked-layer")||e.addSource("clicked-layer",{type:"geojson",data:i}),e.getLayer("clicked-layer")||e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":"#f9f91d","fill-outline-color":"#f9f91d","fill-opacity":.5}},o)),w().then(function(){x()})})}async function w(){e.getSource("terrainMapZen")||e.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",tileSize:512,maxzoom:14})}function x(){try{e.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(o){console.log("ERROR addTerrain"),console.log(o)}}function b(){e.getLayer("clicked-layer")&&e.removeLayer("clicked-layer"),e.getSource("clicked-layer")&&e.removeSource("clicked-layer")}function T(o){const a=S(e.getStyle().layers);e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer");let r=new maplibregl.LngLatBounds;for(let i=0;i<u.length;i++)if(o===u[i].id){e.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:u[i].geometry,properties:{}}}),e.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"white","fill-opacity":.4}},a);const t=u[i].geometry;t.type==="Polygon"?t.coordinates[0].forEach(n=>{r.extend(n)}):t.type==="MultiPolygon"&&t.coordinates.forEach(n=>{n[0].forEach(l=>{r.extend(l)})})}}function _(){e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer")}async function B(o,a,r){P(),F();const t=await(await fetch(`https://api.icgc.cat/territori/${r}/geo/${a}/${o}`)).json();u=t[0].features;const n=document.getElementById("infoPanelContent");n.innerHTML="";let l=[],d=null,m=null;if(t[0].features.length<4)document.getElementById("infoPanelContent").innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let s=0;s<t[0].features.length;s++)l.push(t[0].features[s].id),t[0].features[s].id==="Geocodificador"?d=t[0].features[s].properties:t[0].features[s].id==="Elevació"&&(m=t[0].features[s].properties.value);d&&(n.innerHTML+=`<b>Adreça: </b> ${d.etiqueta} <br>`),m&&(n.innerHTML+=`<b>Coordenades: </b> ${o.toFixed(4)}, ${a.toFixed(4)} <br>`,n.innerHTML+=`<b>Elevació: </b> ${m} metres<br><br>`);for(let s=0;s<l.length;s++)if(l[s]!=="Geocodificador"&&l[s]!=="Elevació"&&l[s]!=="H3 geospatial indexing system"){const c=l[s],p=document.createElement("button");p.textContent=c,p.classList.add("myButtonClass"),p.addEventListener("click",()=>{f=c,h(c,p)}),p.addEventListener("mouseover",()=>{T(c)}),p.addEventListener("mouseout",()=>{_()}),n.appendChild(p),n.appendChild(document.createElement("br"))}l.length>0&&!f?setTimeout(()=>{f=l[0],h(f,n.querySelector(".myButtonClass"))},0):f&&document.querySelectorAll(".myButtonClass").forEach(c=>{c.textContent.includes(f)&&h(f,c)})}H()}function h(o,a){const r=S(e.getStyle().layers);b();const i=document.querySelector(".closeButtonClass");i&&i.parentNode.removeChild(i);let t=new maplibregl.LngLatBounds;for(let d=0;d<u.length;d++)if(o===u[d].id){e.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:u[d].geometry,properties:{}}}),e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":"#f9f91d","fill-outline-color":"#f9f91d","fill-opacity":.5}},r);const m=u[d].geometry;m.type==="Polygon"?m.coordinates[0].forEach(y=>{t.extend(y)}):m.type==="MultiPolygon"&&m.coordinates.forEach(y=>{y[0].forEach(v=>{t.extend(v)})}),document.querySelectorAll(".layer-properties").forEach(y=>y.remove());const c=document.createElement("div");c.classList.add("layer-properties");const p=u[d].properties;for(const[y,v]of Object.entries(p)){const C=document.createElement("div");C.textContent=`${y}: ${v}`,c.appendChild(C)}const g=document.createElement("button");g.textContent="×",g.classList.add("closeButtonClass"),g.addEventListener("click",()=>{b(),c.remove(),g.remove(),a.classList.remove("highlighted-button")}),c.appendChild(g),a.parentNode.insertBefore(c,a.nextSibling),a.parentNode.insertBefore(g,a.nextSibling),document.querySelectorAll(".myButtonClass").forEach(y=>y.classList.remove("highlighted-button")),a.classList.add("highlighted-button")}const l=window.innerWidth<750?k:M;e.fitBounds(t,{padding:l})}function $(){e=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1}),e.on("load",function(){w().then(function(){x()}),e.addControl(new maplibregl.NavigationControl,"top-right");var o=new maplibregl.FullscreenControl;e.addControl(o,"top-right"),e.addControl(new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1}),"top-right"),e.on("click",function(a){var r=document.getElementById("notification");r&&r.classList.remove("show");let i=a.lngLat.lng,t=a.lngLat.lat;f?(b(),B(t,i,E).then(()=>{h(f,document.querySelector(".myButtonClass.highlighted-button"))})):B(t,i,E),L?L.setLngLat([i,t]):L=new maplibregl.Marker({color:"#FF6E42"}).setLngLat([i,t]).addTo(e)})})}function S(o){let a="background";for(var r=0;r<o.length;r++)if(o[r].type=="symbol"&&o[r]["source-layer"]!=="contour")return a=o[r].id,a}async function j(o){const r=await(await fetch(`https://api.icgc.cat/territori/adress/${o}`)).json();console.log("dades",r),r.features?(e.getLayer("punts2")?(e.removeLayer("punts2").removeSource("punts2"),e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:r.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})):(e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:r.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})),e.flyTo({center:[r.features[0].geometry.coordinates[0],r.features[0].geometry.coordinates[1]],zoom:11,essential:!0})):alert(r);const i=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});e.getLayer("punts2")&&(e.on("mouseenter","punts2",function(t){e.getCanvas().style.cursor="pointer",i.setLngLat(t.features[0].geometry.coordinates).setHTML(`Adreça: <b>${t.features[0].properties.etiqueta}</b><br>
      Carrer: <b>${t.features[0].properties.nom}</b><br>
      Municipi: <b>${t.features[0].properties.municipi}</b><br>
      Codi Postal: <b>${t.features[0].properties.codi_postal}</b><br>`).addTo(e)}),e.on("mouseleave","punts2",function(t){e.getCanvas().style.cursor="",i.remove()}))}function F(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function H(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}function P(){var o=document.getElementById("infoPanel");o.classList.add("open"),o.style.width="300px",document.getElementById("openPanel").style.display="none"}function O(){var o=document.getElementById("infoPanel");o.classList.remove("open"),o.style.width="0px",document.getElementById("openPanel").style.display="block"}function q(){$();const o=document.getElementById("textSelector");o.addEventListener("change",()=>{const a=o.value;j(a)})}window.addEventListener("DOMContentLoaded",q);window.closePanel=O;window.openPanel=P;window.onBaseChange=I;
