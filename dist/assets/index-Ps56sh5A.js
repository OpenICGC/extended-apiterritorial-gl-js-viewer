(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();var e,b;let k="",w=!0,g,m=null,h;const j={top:5,bottom:window.innerHeight*.5},q={top:100,bottom:100,left:300,right:50};async function A(){const n=S(e.getStyle().layers),t=document.getElementById("serveiSelector2").value;let s=null;if(e.getLayer("clicked-layer")){const o=e.getSource("clicked-layer");o&&o._data&&(s=o._data)}let r;t==="orto"?r="https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json":t==="topo"?r="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json":t==="fosc"&&(r="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json"),e.setStyle(r),e.once("styledata",()=>{s&&(e.getSource("clicked-layer")||e.addSource("clicked-layer",{type:"geojson",data:s}),e.getLayer("clicked-layer")||e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":"#f9f91d","fill-outline-color":"#f9f91d","fill-opacity":.5}},n)),x().then(function(){I()})})}async function x(){e.getSource("terrainMapZen")||e.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",tileSize:512,maxzoom:14})}function I(){try{e.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(n){console.log("ERROR addTerrain"),console.log(n)}}function C(){e.getLayer("clicked-layer")&&e.removeLayer("clicked-layer"),e.getSource("clicked-layer")&&e.removeSource("clicked-layer")}function N(n){const i=S(e.getStyle().layers);e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer");for(let t=0;t<g.length;t++)n===g[t].id&&(e.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:g[t].geometry,properties:{}}}),e.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},i))}function F(){e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer")}async function B(n,i,t){if(_(),T(),R(),h){for(let d=0;d<h.length;d++){const{id:u,checked:p}=h[d];p===!0?(t!==""&&(t+=","),t+=u):w=!1}t+=",geocoder,elevacions"}w&&(t="all");const s=document.getElementById("infoPanelContent"),o=await(await fetch(`https://api.icgc.cat/territori/${t}/geo/${i}/${n}`)).json();o.responses&&(g=o.responses.features,s.innerHTML="");let c=[],a=null,l=null;if(!o.numResponses||!o.responses)s.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",M();else if(o.numResponses<2)s.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let d=0;d<o.responses.features.length;d++)c.push(o.responses.features[d].id),o.responses.features[d].id==="Geocodificador"?a=o.responses.features[d].properties:o.responses.features[d].id==="Elevació"&&(l=o.responses.features[d].properties.value);a&&(s.innerHTML+=`<b>Adreça: </b> ${a.etiqueta} <br>`),l&&(s.innerHTML+=`<b>Coordenades: </b> ${n.toFixed(4)}, ${i.toFixed(4)} <br>`,s.innerHTML+=`<b>Elevació: </b> ${l} metres<br><br>`);for(let d=0;d<c.length;d++)if(c[d]!=="Geocodificador"&&c[d]!=="Elevació"&&c[d]!=="H3 geospatial indexing system"){const u=c[d],p=document.createElement("button");p.textContent=u,p.classList.add("myButtonClass"),p.addEventListener("click",()=>{m=u,v(u,p)}),p.addEventListener("mouseover",()=>{N(u)}),p.addEventListener("mouseout",()=>{F()}),s.appendChild(p),s.appendChild(document.createElement("br"))}c.length>0&&!m?setTimeout(()=>{m=c[0],v(m,s.querySelector(".myButtonClass"))},25):m&&document.querySelectorAll(".myButtonClass").forEach(u=>{u.textContent.includes(m)&&v(m,u)})}M()}function v(n,i){const t=S(e.getStyle().layers);C();const s=document.querySelector(".closeButtonClass");s&&s.parentNode.removeChild(s);let r=new maplibregl.LngLatBounds;for(let a=0;a<g.length;a++)if(n===g[a].id){e.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:g[a].geometry,properties:{}}}),e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":"#f9f91d","fill-outline-color":"#f9f91d","fill-opacity":.5}},t);const l=g[a].geometry;l&&(l.type==="Polygon"?l.coordinates[0].forEach(f=>{r.extend(f)}):l.type==="MultiPolygon"&&l.coordinates.forEach(f=>{f[0].forEach(L=>{r.extend(L)})})),document.querySelectorAll(".layer-properties").forEach(f=>f.remove());const u=document.createElement("div");u.classList.add("layer-properties");const p=g[a].properties;for(const[f,L]of Object.entries(p)){const E=document.createElement("div");E.textContent=`${f}: ${L}`,u.appendChild(E)}const y=document.createElement("button");y.textContent="×",y.classList.add("closeButtonClass"),y.addEventListener("click",()=>{C(),u.remove(),y.remove(),i.classList.remove("highlighted-button")}),u.appendChild(y),i&&(i.parentNode.insertBefore(u,i.nextSibling),i.parentNode.insertBefore(y,i.nextSibling)),document.querySelectorAll(".myButtonClass").forEach(f=>f.classList.remove("highlighted-button")),i.classList.add("highlighted-button")}const c=window.innerWidth<750?j:q;r&&e.fitBounds(r,{padding:c})}function H(){e=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1}),e.on("load",function(){x().then(function(){I()}),e.addControl(new maplibregl.NavigationControl,"top-right");var n=new maplibregl.FullscreenControl;e.addControl(n,"top-right");let i=null;const t=10,s=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});e.addControl(s,"top-right");function r(o,c,a,l){const u=(a-o)*Math.PI/180,p=(l-c)*Math.PI/180,y=Math.sin(u/2)*Math.sin(u/2)+Math.cos(o*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(p/2)*Math.sin(p/2);return 6371e3*(2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y)))}s.on("geolocate",function(o){const c=o.coords.longitude,a=o.coords.latitude;if(i&&r(i.lat,i.lon,a,c)<t)return;i={lon:c,lat:a};const l={lngLat:{lng:c,lat:a}};e.fire("click",l)}),e.addControl(new D,"top-right"),e.on("click",function(o){var c=document.getElementById("notification");c&&c.classList.remove("show");let a=o.lngLat.lng,l=o.lngLat.lat;m&&l&&a?(C(),B(l,a,k).then(()=>{document.querySelector(".myButtonClass.highlighted-button")&&v(m,document.querySelector(".myButtonClass.highlighted-button"))})):B(l,a,k),b?b.setLngLat([a,l]):b=new maplibregl.Marker({color:"#FF6E42"}).setLngLat([a,l]).addTo(e)})})}function S(n){let i="background";for(var t=0;t<n.length;t++)if(n[t].type=="symbol"&&n[t]["source-layer"]!=="contour")return i=n[t].id,i}async function O(n){const t=await(await fetch(`https://api.icgc.cat/territori/adress/${n}`)).json();t.features?(e.getLayer("punts2")?(e.removeLayer("punts2").removeSource("punts2"),e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:t.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})):(e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:t.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})),e.flyTo({center:[t.features[0].geometry.coordinates[0],t.features[0].geometry.coordinates[1]],zoom:11,essential:!0})):alert(t);const s=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});e.getLayer("punts2")&&(e.on("mouseenter","punts2",function(r){e.getCanvas().style.cursor="pointer",s.setLngLat(r.features[0].geometry.coordinates).setHTML(`Adreça: <b>${r.features[0].properties.etiqueta}</b><br>
      Carrer: <b>${r.features[0].properties.nom}</b><br>
      Municipi: <b>${r.features[0].properties.municipi}</b><br>
      Codi Postal: <b>${r.features[0].properties.codi_postal}</b><br>`).addTo(e)}),e.on("mouseleave","punts2",function(r){e.getCanvas().style.cursor="",s.remove()}))}function R(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function M(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}class D{onAdd(i){return this._map=i,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function G(){var n=document.getElementById("notification");n&&n.classList.remove("show");var i=document.getElementById("myModal"),t=document.getElementById("configListContainer");i.style.display="block",fetch("https://api.icgc.cat/territori/info").then(r=>r.json()).then(r=>{t.innerHTML="",r.forEach(o=>{if(o.nomAPI!=="geocoder"&&o.nomAPI!=="elevacions"){const c=document.createElement("div");c.className="config-item";const a=document.createElement("input");a.type="checkbox",a.id=`${o.nomAPI}`,a.name=o.name,a.checked=!0;const l=document.createElement("label");l.htmlFor=`checkbox-${o.nomAPI}`,l.textContent=o.text,c.appendChild(a),c.appendChild(l),t.appendChild(c)}}),_()}).catch(r=>console.error("Error fetching data:",r));var s=document.getElementsByClassName("close")[0];s.onclick=function(){P(),i.style.display="none"},window.onclick=function(r){r.target==i&&(P(),i.style.display="none")}}function P(){const n=document.querySelectorAll('.config-item input[type="checkbox"]'),i=Array.from(n).map(t=>({id:t.id,checked:t.checked}));localStorage.setItem("layerConfig",JSON.stringify(i))}function _(){const n=JSON.parse(localStorage.getItem("layerConfig"));n&&(h=n,n.forEach(i=>{const t=document.getElementById(i.id);t&&(t.checked=i.checked)}))}function T(){var n=document.getElementById("infoPanel");n.classList.add("open"),n.style.width="300px",document.getElementById("openPanel").style.display="none"}function W(){var n=document.getElementById("infoPanel");n.classList.remove("open"),n.style.width="0px",document.getElementById("openPanel").style.display="block"}function z(){H();const n=document.getElementById("textSelector");n.addEventListener("change",()=>{const t=n.value;O(t)}),document.getElementById("layerConfig").addEventListener("click",()=>{G()})}window.addEventListener("DOMContentLoaded",z);"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(n=>{console.log("Service Worker registered with scope:",n.scope)},n=>{console.log("Service Worker registration failed:",n)})});window.closePanel=W;window.openPanel=T;window.onBaseChange=A;
