(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();var e,g;let x="",P=!0,m,y=null,L;const q={top:5,bottom:window.innerHeight*.5},$={top:100,bottom:100,left:300,right:50};async function j(){const t=S(e.getStyle().layers),n=document.getElementById("serveiSelector2").value;let s=null;if(e.getLayer("clicked-layer")){const o=e.getSource("clicked-layer");o&&o._data&&(s=o._data)}let r;n==="orto"?r="https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json":n==="topo"?r="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json":n==="fosc"&&(r="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json"),e.setStyle(r),e.once("styledata",()=>{if(s){const o=localStorage.getItem("clickedLayerColor")||"#f9f91d";e.getSource("clicked-layer")||e.addSource("clicked-layer",{type:"geojson",data:s}),e.getLayer("clicked-layer")||e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":o,"fill-outline-color":o,"fill-opacity":.5}},t)}I().then(function(){_()})})}async function I(){e.getSource("terrainMapZen")||e.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",tileSize:512,maxzoom:14})}function _(){try{e.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(t){console.log("ERROR addTerrain"),console.log(t)}}function k(){e.getLayer("clicked-layer")&&e.removeLayer("clicked-layer"),e.getSource("clicked-layer")&&e.removeSource("clicked-layer")}function N(t){const c=S(e.getStyle().layers);e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer");for(let n=0;n<m.length;n++)t===m[n].id&&(e.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:m[n].geometry,properties:{}}}),e.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},c))}function H(){e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer")}async function M(t,c,n){if(A(),T(),D(),L){for(let i=0;i<L.length;i++){const{id:u,checked:d}=L[i];d===!0?(n!==""&&(n+=","),n+=u):P=!1}n+=",geocoder,elevacions"}P&&(n="all");const s=document.getElementById("infoPanelContent"),o=await(await fetch(`https://api.icgc.cat/territori/${n}/geo/${c}/${t}`)).json();o.responses&&(m=o.responses.features,s.innerHTML="");let a=[],l=null,p=null;if(!o.numResponses||!o.responses)s.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",w();else if(o.numResponses<1)s.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let i=0;i<o.responses.features.length;i++)a.push(o.responses.features[i].id),o.responses.features[i].id==="Geocodificador"?l=o.responses.features[i].properties:o.responses.features[i].id==="Elevació"&&(p=o.responses.features[i].properties.value);l&&(s.innerHTML+=`<b>Adreça: </b> ${l.etiqueta} <br>`),p&&(s.innerHTML+=`<b>Coordenades: </b> ${t.toFixed(4)}, ${c.toFixed(4)} <br>`,s.innerHTML+=`<b>Elevació: </b> ${p} metres<br><br>`);for(let i=0;i<a.length;i++)if(a[i]!=="Geocodificador"&&a[i]!=="Elevació"&&a[i]!=="H3 geospatial indexing system"){const u=a[i],d=document.createElement("button");d.textContent=u,d.classList.add("myButtonClass"),d.addEventListener("click",()=>{y=u,C(u,d)}),d.addEventListener("mouseover",()=>{N(u)}),d.addEventListener("mouseout",()=>{H()}),s.appendChild(d),s.appendChild(document.createElement("br"))}a.length>0&&!y?setTimeout(()=>{y=a[0],C(y,s.querySelector(".myButtonClass"))},25):y&&document.querySelectorAll(".myButtonClass").forEach(u=>{u.textContent.includes(y)&&C(y,u)})}w()}function C(t,c){const n=S(e.getStyle().layers);k();const s=document.querySelector(".closeButtonClass");s&&s.parentNode.removeChild(s);let r=new maplibregl.LngLatBounds;for(let l=0;l<m.length;l++)if(t===m[l].id){const p=localStorage.getItem("clickedLayerColor")||"#f9f91d";e.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:m[l].geometry,properties:{}}}),e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":p,"fill-outline-color":p,"fill-opacity":.5}},n);const i=m[l].geometry;i&&(i.type==="Polygon"?i.coordinates[0].forEach(f=>{r.extend(f)}):i.type==="MultiPolygon"&&i.coordinates.forEach(f=>{f[0].forEach(b=>{r.extend(b)})})),document.querySelectorAll(".layer-properties").forEach(f=>f.remove());const d=document.createElement("div");d.classList.add("layer-properties");const v=m[l].properties;for(const[f,b]of Object.entries(v)){const E=document.createElement("div");E.textContent=`${f}: ${b}`,d.appendChild(E)}const h=document.createElement("button");h.textContent="×",h.classList.add("closeButtonClass"),h.addEventListener("click",()=>{k(),d.remove(),h.remove(),c.classList.remove("highlighted-button")}),d.appendChild(h),c&&(c.parentNode.insertBefore(d,c.nextSibling),c.parentNode.insertBefore(h,c.nextSibling)),document.querySelectorAll(".myButtonClass").forEach(f=>f.classList.remove("highlighted-button")),c.classList.add("highlighted-button")}const a=window.innerWidth<750?q:$;r&&e.fitBounds(r,{padding:a})}function O(){e=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1}),e.on("load",function(){I().then(function(){_()}),e.addControl(new maplibregl.NavigationControl,"top-right");let t=null;const c=20,n=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});e.addControl(n,"top-right");function s(r,o,a,l){const i=(a-r)*Math.PI/180,u=(l-o)*Math.PI/180,d=Math.sin(i/2)*Math.sin(i/2)+Math.cos(r*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}n.on("geolocate",function(r){const o=r.coords.longitude,a=r.coords.latitude;if(t&&s(t.lat,t.lon,a,o)<c)return;t={lon:o,lat:a};const l={lngLat:{lng:o,lat:a}};e.fire("click",l)}),e.addControl(new R,"top-right"),e.on("click",function(r){var o=document.getElementById("notification");o&&o.classList.remove("show");let a=r.lngLat.lng,l=r.lngLat.lat;y&&l&&a?(k(),M(l,a,x).then(()=>{document.querySelector(".myButtonClass.highlighted-button")&&C(y,document.querySelector(".myButtonClass.highlighted-button"))})):M(l,a,x);const p=localStorage.getItem("markerColor")||"#ff6e42";g?g.setLngLat([a,l]):g=new maplibregl.Marker({color:p}).setLngLat([a,l]).addTo(e)})})}function S(t){let c="background";for(var n=0;n<t.length;n++)if(t[n].type=="symbol"&&t[n]["source-layer"]!=="contour")return c=t[n].id,c}async function F(t){const n=await(await fetch(`https://api.icgc.cat/territori/adress/${t}`)).json();n.features?(e.getLayer("punts2")?(e.removeLayer("punts2").removeSource("punts2"),e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:n.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})):(e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:n.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})),e.flyTo({center:[n.features[0].geometry.coordinates[0],n.features[0].geometry.coordinates[1]],zoom:11,essential:!0})):alert(n);const s=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});e.getLayer("punts2")&&(e.on("mouseenter","punts2",function(r){e.getCanvas().style.cursor="pointer",s.setLngLat(r.features[0].geometry.coordinates).setHTML(`Adreça: <b>${r.features[0].properties.etiqueta}</b><br>
      Carrer: <b>${r.features[0].properties.nom}</b><br>
      Municipi: <b>${r.features[0].properties.municipi}</b><br>
      Codi Postal: <b>${r.features[0].properties.codi_postal}</b><br>`).addTo(e)}),e.on("mouseleave","punts2",function(r){e.getCanvas().style.cursor="",s.remove()}))}function D(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function w(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}class R{onAdd(c){return this._map=c,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function G(){var t=document.getElementById("notification");t&&t.classList.remove("show");var c=document.getElementById("myModal"),n=document.getElementById("configListContainer");c.style.display="block",fetch("https://api.icgc.cat/territori/info").then(o=>o.json()).then(o=>{n.innerHTML="";const a=document.createElement("div"),l=document.createElement("input");l.type="checkbox",l.id="selectAllCheckbox";const p=document.createElement("label");a.id="selectDiv",p.id="selectLabel",p.htmlFor="selectAllCheckbox",p.textContent=" Seleccionar tots",a.appendChild(l),a.appendChild(p),n.appendChild(a),l.addEventListener("change",function(){n.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)').forEach(u=>{u.checked=l.checked})}),o.forEach(i=>{if(i.nomAPI!=="geocoder"&&i.nomAPI!=="elevacions"){const u=document.createElement("div");u.className="config-item";const d=document.createElement("input");d.type="checkbox",d.id=`${i.nomAPI}`,d.name=i.name,d.checked=!0;const v=document.createElement("label");v.htmlFor=`checkbox-${i.nomAPI}`,v.textContent=i.text,u.appendChild(d),u.appendChild(v),n.appendChild(u),d.addEventListener("change",function(){r()})}}),A(),r()}).catch(o=>console.error("Error fetching data:",o));var s=document.getElementsByClassName("close")[0];s.onclick=function(){B(),c.style.display="none"},window.onclick=function(o){o.target==c&&(B(),c.style.display="none")};function r(){const o=n.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)'),a=Array.from(o).every(l=>l.checked);selectAllCheckbox.checked=a}}function B(){const t=document.querySelectorAll('.config-item input[type="checkbox"]'),c=Array.from(t).map(n=>({id:n.id,checked:n.checked}));localStorage.setItem("layerConfig",JSON.stringify(c))}function A(){const t=JSON.parse(localStorage.getItem("layerConfig"));t&&(L=t,t.forEach(c=>{const n=document.getElementById(c.id);n&&(n.checked=c.checked)}))}function T(){var t=document.getElementById("infoPanel");t.classList.add("open"),t.style.width="300px",document.getElementById("openPanel").style.display="none"}function W(){var t=document.getElementById("infoPanel");t.classList.remove("open"),t.style.width="0px",document.getElementById("openPanel").style.display="block"}function z(){O();const t=document.getElementById("textSelector");t.addEventListener("change",()=>{const n=t.value;F(n)}),document.getElementById("layerConfig").addEventListener("click",()=>{G()})}window.addEventListener("DOMContentLoaded",z);document.getElementById("layerColor").addEventListener("input",t=>{const c=t.target.value;localStorage.setItem("clickedLayerColor",c),Z(c)});function Z(t){e.getLayer("clicked-layer")&&(e.setPaintProperty("clicked-layer","fill-color",t),e.setPaintProperty("clicked-layer","fill-outline-color",t))}document.getElementById("markerColor").addEventListener("input",t=>{const c=t.target.value;localStorage.setItem("markerColor",c),J(c)});function J(t){if(g){g.setPopup(null);const c=g.getLngLat();g.remove(),g=new maplibregl.Marker({color:t}).setLngLat(c).addTo(e)}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(t=>{console.log("Service Worker registered with scope:",t.scope)},t=>{console.log("Service Worker registration failed:",t)})});window.closePanel=W;window.openPanel=T;window.onBaseChange=j;
