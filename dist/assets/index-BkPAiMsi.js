(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(l){if(l.ep)return;l.ep=!0;const o=r(l);fetch(l.href,o)}})();var e,v;let A="",F=!0,b,h=null,M,S="#000000";const O={top:60,bottom:window.innerHeight*.5+25,left:60,right:60},R={top:100,bottom:100,left:300,right:50};async function G(){const n=document.getElementById("serveiSelector2").value;let r=null,s=null;if(e.getLayer("clicked-layer")){const o=e.getSource("clicked-layer");o&&o._data&&(r=o._data,e.getLayer("clicked-layer-labels")&&(s=o._data))}let l;n==="orto"?(l="https://geoserveis.icgc.cat/contextmaps/icgc_orto_estandard.json",S="#FFFFFF"):n==="topo"?(l="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json",S="#000000"):n==="fosc"&&(l="https://geoserveis.icgc.cat/contextmaps/icgc_mapa_base_fosc.json",S="#FFFFFF"),e.setStyle(l),e.once("styledata",()=>{const o=_(e.getStyle().layers),i=localStorage.getItem("clickedLayerColor")||"#f9f91d";r&&(e.getSource("clicked-layer")||e.addSource("clicked-layer",{type:"geojson",data:r}),e.getLayer("clicked-layer")||e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":i,"fill-outline-color":i,"fill-opacity":.5}},o),s&&(e.removeLayer("clicked-layer"),e.getLayer("clicked-layer-labels")||(e.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":8,"circle-color":i}}),e.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","Codi_ICC"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":S}})))),n==="topo"?e.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):n==="orto"?e.setSky({"sky-color":"#37709e","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"}):n==="fosc"&&e.setSky({"sky-color":"#232423","sky-horizon-blend":.3,"horizon-color":"#969996","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#383838"}),$().then(function(){q()})})}async function $(){e.getSource("terrainMapZen")||e.addSource("terrainMapZen",{type:"raster-dem",url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",tileSize:512,maxzoom:14})}function q(){try{e.setTerrain({source:"terrainMapZen",exaggeration:1.5})}catch(t){console.log("ERROR addTerrain"),console.log(t)}}function P(){e.getLayer("clicked-layer")&&e.removeLayer("clicked-layer"),e.getLayer("clicked-layer-labels")&&e.removeLayer("clicked-layer-labels"),e.getSource("clicked-layer")&&e.removeSource("clicked-layer")}function W(t){const n=_(e.getStyle().layers);e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer");for(let r=0;r<b.length;r++)t===b[r].id&&(e.addSource("hovered-layer",{type:"geojson",data:{type:"Feature",geometry:b[r].geometry,properties:{}}}),e.addLayer({id:"hovered-layer",type:"fill",source:"hovered-layer",layout:{},paint:{"fill-color":"orange","fill-opacity":.3}},n))}function Z(){e.getLayer("hovered-layer")&&e.removeLayer("hovered-layer"),e.getSource("hovered-layer")&&e.removeSource("hovered-layer")}async function T(t,n,r){if(N(),H(),X(),M){for(let a=0;a<M.length;a++){const{id:f,checked:u}=M[a];u===!0?(r!==""&&(r+=","),r+=f):F=!1}r+=",geocoder,elevacions"}F&&(r="all");const s=document.getElementById("infoPanelContent"),o=await(await fetch(`https://api.icgc.cat/territori/${r}/geo/${n}/${t}`)).json();o.responses&&(b=o.responses.features,s.innerHTML="");let i=[],c=null,p=null,d=null,y=null;if(!o.numResponses||!o.responses)s.innerHTML="S'ha produït un error en processar la sol·licitud. Si us plau, torna-ho a intentar o selecciona un altre punt.",j();else if(o.numResponses<1)s.innerHTML="No hi ha dades sobre el punt seleccionat.";else{for(let a=0;a<o.responses.features.length;a++)i.push(o.responses.features[a].id),o.responses.features[a].id==="Geocodificador"?c=o.responses.features[a].properties:o.responses.features[a].id==="Elevació"?p=o.responses.features[a].properties.value:o.responses.features[a].id==="Temperatura mitjana anual"?(console.log("catch temp"),d=o.responses.features[a].properties.GRAY_INDEX):o.responses.features[a].id==="Precipitació mitjana anual"&&(y=o.responses.features[a].properties.GRAY_INDEX);c&&(s.innerHTML+=`<p style='font-size: 1.2em; margin-bottom: 12px'><b>${c.etiqueta}</b> <span style='font-size: 0.65em; color: #8D9596'>(distància: ${c.distancia} km)</span></p>`),p&&(s.innerHTML+=`<b>Coordenades: </b> ${t.toFixed(5)}, ${n.toFixed(5)} <br>`,s.innerHTML+=`<b>Elevació: </b> ${p} metres<br>`,(d||y)&&(s.innerHTML+=`<b>Temperatura mijana anual: </b> ${d.toFixed(2)} ºC<br>`,s.innerHTML+=`<b>Precipitació mijana anual: </b> ${y.toFixed(2)} mm<br><br>`));for(let a=0;a<i.length;a++)if(i[a]!=="Geocodificador"&&i[a]!=="Elevació"&&i[a]!=="H3 geospatial indexing system"&&i[a]!=="Temperatura mitjana anual"&&i[a]!=="Precipitació mitjana anual"){const f=i[a],u=document.createElement("button");u.textContent=f,u.classList.add("myButtonClass"),u.addEventListener("click",()=>{h=f,B(f,u)}),u.addEventListener("mouseover",()=>{W(f)}),u.addEventListener("mouseout",()=>{Z()}),s.appendChild(u),s.appendChild(document.createElement("br"))}i.length>0&&!h?setTimeout(()=>{h=i[0],B(h,s.querySelector(".myButtonClass"))},25):h&&document.querySelectorAll(".myButtonClass").forEach(f=>{f.textContent.includes(h)&&B(h,f)})}j()}function B(t,n){const r=_(e.getStyle().layers);P();const s=document.querySelector(".closeButtonClass");s&&s.parentNode.removeChild(s);let l=new maplibregl.LngLatBounds;for(let c=0;c<b.length;c++)if(t===b[c].id){const p=localStorage.getItem("clickedLayerColor")||"#f9f91d",d=document.createElement("div");if(d.classList.add("layer-properties"),t==="Vèrtex xarxa utilitària"){const k=b[c].features,m={type:"FeatureCollection",features:k};e.addSource("clicked-layer",{type:"geojson",data:m}),e.addLayer({id:"clicked-layer",type:"circle",source:"clicked-layer",paint:{"circle-radius":8,"circle-color":p}}),e.addLayer({id:"clicked-layer-labels",type:"symbol",source:"clicked-layer",layout:{"text-field":["get","Codi_ICC"],"text-font":["Arial-Bold"],"text-size":12,"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-color":S}});const g=["Codi_ICC","Municipi","distance_km","Enllaç"];k.forEach((L,re)=>{const C=L.geometry.coordinates;C&&C.length===2&&typeof C[0]=="number"&&typeof C[1]=="number"&&l.extend(C);const I=L.properties;I&&(g.forEach(x=>{if(I[x]!==void 0){const w=document.createElement("div");if(x==="Enllaç"){const E=document.createElement("a"),D=I[x];E.href=D,E.textContent="Fitxa ↓",E.target="_blank",E.classList.add("button-link"),w.appendChild(E)}else w.textContent=`${x}: ${I[x]}`;d.appendChild(w)}}),d.appendChild(document.createElement("br")))})}else{const u=b[c].geometry;if(u){e.addSource("clicked-layer",{type:"geojson",data:{type:"Feature",geometry:u,properties:{}}}),e.addLayer({id:"clicked-layer",type:"fill",source:"clicked-layer",layout:{},paint:{"fill-color":p,"fill-outline-color":p,"fill-opacity":.5}},r),u.type==="Polygon"?u.coordinates[0].forEach(m=>{m&&m.length===2&&typeof m[0]=="number"&&typeof m[1]=="number"&&l.extend(m)}):u.type==="MultiPolygon"&&u.coordinates.forEach(m=>{m[0].forEach(g=>{g&&g.length===2&&typeof g[0]=="number"&&typeof g[1]=="number"&&l.extend(g)})});const k=b[c].properties;if(k)for(const[m,g]of Object.entries(k)){const L=document.createElement("div");L.textContent=`${m}: ${g}`,d.appendChild(L)}}}document.querySelectorAll(".layer-properties").forEach(u=>u.remove());const a=document.createElement("button");a.textContent="×",a.classList.add("closeButtonClass"),a.addEventListener("click",()=>{P(),d.remove(),a.remove(),n.classList.remove("highlighted-button")}),d.appendChild(a),n&&(n.parentNode.insertBefore(d,n.nextSibling),n.parentNode.insertBefore(a,n.nextSibling)),document.querySelectorAll(".myButtonClass").forEach(u=>u.classList.remove("highlighted-button")),n.classList.add("highlighted-button")}const i=window.innerWidth<750?O:R;l.isEmpty()||e.fitBounds(l,{padding:i})}function J(){Y(),e=new maplibregl.Map({container:"map",style:"https://geoserveis.icgc.cat/contextmaps/icgc_mapa_estandard_general.json",center:[2.0042,41.7747],zoom:7,maxZoom:18,attributionControl:!1,hash:!1,maxPitch:85}),e.on("load",function(){$().then(function(){q()}),e.addControl(new maplibregl.NavigationControl,"top-right"),e.setSky({"sky-color":"#a5f0f0","sky-horizon-blend":.3,"horizon-color":"#e1e3e3","horizon-fog-blend":.9,"fog-ground-blend":.85,"fog-color":"#c5d6d6"});let t=null;const n=20,r=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});e.addControl(r,"top-right");function s(l,o,i,c){const d=(i-l)*Math.PI/180,y=(c-o)*Math.PI/180,a=Math.sin(d/2)*Math.sin(d/2)+Math.cos(l*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(y/2)*Math.sin(y/2);return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}r.on("geolocate",function(l){const o=l.coords.longitude,i=l.coords.latitude;if(t&&s(t.lat,t.lon,i,o)<n)return;t={lon:o,lat:i};const c={lngLat:{lng:o,lat:i}};e.fire("click",c)}),e.addControl(new V,"top-right"),e.on("click",function(l){var o=document.getElementById("notification");o&&o.classList.remove("show");let i=l.lngLat.lng,c=l.lngLat.lat;h&&c&&i?(P(),T(c,i,A).then(()=>{document.querySelector(".myButtonClass.highlighted-button")&&B(h,document.querySelector(".myButtonClass.highlighted-button"))})):T(c,i,A);const p=localStorage.getItem("markerColor")||"#ff6e42";v?v.setLngLat([i,c]):v=new maplibregl.Marker({color:p}).setLngLat([i,c]).addTo(e)}),K()})}function _(t){let n="background";for(var r=0;r<t.length;r++)if(t[r].type=="symbol")return n=t[r].id,n}async function U(t){const r=await(await fetch(`https://api.icgc.cat/territori/adress/${t}`)).json();r.features?(e.getLayer("punts2")?(e.removeLayer("punts2").removeSource("punts2"),e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:r.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})):(e.addSource("punts2",{type:"geojson",data:{type:"FeatureCollection",features:r.features}}),e.addLayer({id:"punts2",type:"circle",source:"punts2",paint:{"circle-color":"red","circle-opacity":.8,"circle-radius":6}})),e.flyTo({center:[r.features[0].geometry.coordinates[0],r.features[0].geometry.coordinates[1]],zoom:11,essential:!0})):alert(r);const s=new maplibregl.Popup({closeButton:!1,closeOnClick:!1});e.getLayer("punts2")&&(e.on("mouseenter","punts2",function(l){e.getCanvas().style.cursor="pointer",s.setLngLat(l.features[0].geometry.coordinates).setHTML(`Adreça: <b>${l.features[0].properties.etiqueta}</b><br>
      Carrer: <b>${l.features[0].properties.nom}</b><br>
      Municipi: <b>${l.features[0].properties.municipi}</b><br>
      Codi Postal: <b>${l.features[0].properties.codi_postal}</b><br>`).addTo(e)}),e.on("mouseleave","punts2",function(l){e.getCanvas().style.cursor="",s.remove()}))}function X(){document.getElementById("loader").style.display="block",document.getElementById("infoPanelContent").style.display="none"}function j(){document.getElementById("loader").style.display="none",document.getElementById("infoPanelContent").style.display="block"}function Y(){document.getElementById("mapLoader").style.display="flex"}function K(){document.getElementById("mapLoader").style.display="none"}class V{onAdd(n){return this._map=n,this._container=document.createElement("button"),this._container.className="maplibregl-ctrl pitch-control",this._container.textContent="3D",this._container.onclick=()=>{this._map.getPitch()===0?(this._map.easeTo({pitch:60}),this._container.textContent="2D"):(this._map.easeTo({pitch:0}),this._container.textContent="3D")},this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}}function Q(){var t=document.getElementById("notification");t&&t.classList.remove("show");var n=document.getElementById("myModal"),r=document.getElementById("configListContainer");n.style.display="block",fetch("https://api.icgc.cat/territori/info").then(o=>o.json()).then(o=>{r.innerHTML="";const i=document.createElement("div"),c=document.createElement("input");c.type="checkbox",c.id="selectAllCheckbox";const p=document.createElement("label");i.id="selectDiv",p.id="selectLabel",p.htmlFor="selectAllCheckbox",p.textContent=" Seleccionar tots",i.appendChild(c),i.appendChild(p),r.appendChild(i),c.addEventListener("change",function(){r.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)').forEach(y=>{y.checked=c.checked})}),o.forEach(d=>{if(d.nomAPI!=="geocoder"&&d.nomAPI!=="elevacions"&&d.nomAPI!=="h3"&&d.nomAPI!=="precipitacio"&&d.nomAPI!=="temperatura"){const y=document.createElement("div");y.className="config-item";const a=document.createElement("input");a.type="checkbox",a.id=`${d.nomAPI}`,a.name=d.name,a.checked=!0;const f=document.createElement("label");f.htmlFor=`checkbox-${d.nomAPI}`,f.textContent=d.text,y.appendChild(a),y.appendChild(f),r.appendChild(y),a.addEventListener("change",function(){l()})}}),N(),l()}).catch(o=>console.error("Error fetching data:",o));var s=document.getElementsByClassName("close")[0];s.onclick=function(){z(),n.style.display="none"},window.onclick=function(o){o.target==n&&(z(),n.style.display="none")};function l(){const o=r.querySelectorAll('input[type="checkbox"]:not(#selectAllCheckbox)'),i=Array.from(o).every(c=>c.checked);selectAllCheckbox.checked=i}}function z(){const t=document.querySelectorAll('.config-item input[type="checkbox"]'),n=Array.from(t).map(r=>({id:r.id,checked:r.checked}));localStorage.setItem("layerConfig",JSON.stringify(n))}function N(){const t=JSON.parse(localStorage.getItem("layerConfig"));t&&(M=t,t.forEach(n=>{const r=document.getElementById(n.id);r&&(r.checked=n.checked)}))}function H(){var t=document.getElementById("infoPanel");t.classList.add("open"),t.style.width="300px",document.getElementById("openPanel").style.display="none"}function ee(){var t=document.getElementById("infoPanel");t.classList.remove("open"),t.style.width="0px",document.getElementById("openPanel").style.display="block"}function te(){J();const t=document.getElementById("textSelector");t.addEventListener("change",()=>{const r=t.value;U(r)}),document.getElementById("layerConfig").addEventListener("click",()=>{Q()})}window.addEventListener("DOMContentLoaded",te);document.getElementById("layerColor").addEventListener("input",t=>{const n=t.target.value;localStorage.setItem("clickedLayerColor",n),oe(n)});function oe(t){e.getLayer("clicked-layer")&&(e.setPaintProperty("clicked-layer","fill-color",t),e.setPaintProperty("clicked-layer","fill-outline-color",t))}document.getElementById("markerColor").addEventListener("input",t=>{const n=t.target.value;localStorage.setItem("markerColor",n),ne(n)});function ne(t){if(v){v.setPopup(null);const n=v.getLngLat();v.remove(),v=new maplibregl.Marker({color:t}).setLngLat(n).addTo(e)}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/serviceworker.js").then(t=>{console.log("Service Worker registered with scope:",t.scope)},t=>{console.log("Service Worker registration failed:",t)})});window.closePanel=ee;window.openPanel=H;window.onBaseChange=G;
